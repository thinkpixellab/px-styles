////
/// @group modules.controls
////

@use '../utils' as *;
@use '../site' as *;

// Implementation notes:
//
// Some general control style implementation notes:
//
// - For most controls, we use css-map to generate the style. This means that we are, for the most
//   part, keeping the css in a map until we finalize it and then we use css-map($css) to actually
//   generate the style. This prevents duplicate properties and lets us keep the css fluid as we
//   merge in defaults and overrides, etc.
//
// - We're not using @extend much, primarily because the expectation is that in many cases these
//   control styles are generated from within component files with relatively narrow scope, where
//   @extend won't provide much advantage.
//
// - The general flow for a control style that accounts for various defaults, overrides, etc. is as
//   follows:
//   1. Make a call to contr

// ----------------------------------------------------------------------------
// helpers
// ----------------------------------------------------------------------------

/// Generates one of a number of "canned" / common focus styles as a css map (which can be combined
/// with the css-map function to generate the correct focus visual css)
///
///
/// @param {shadow | outline} $style A named style.
/// @param {color} $color [null]
///
/// @example control-focus-style('outline', red) // => (outline-offset: 0px, outline: 1px dashed red)

@function control-focus-style($style, $color: null) {
    @if ($style == 'shadow') {
        $color: if-null($color, get('focus:shadow-color'));
        $width: get('focus:shadow-width');
        @return (box-shadow: 0 0 0 $width $color);
    }
    @if ($style == 'outline') {
        $color: if-null($color, get('focus:outline-color'));
        @return (outline-offset: 0px, outline: 1px dashed $color);
    }
}

// extract an accent color from any of the properties in $props, with a
// fallback value of 'controls:accent' (note: last property in list wins)

@function -get-control-accent($overrides, $accent-props...) {
    $accent: get('controls:accent');
    @each $prop in $accent-props {
        $accent: map-get-default($overrides, $prop, $accent);
    }
    @return $accent;
}

@mixin -focus-style($style, $color: null) {
    @include css-map(-focus-style($style, $color));
}

@mixin -focus($style, $color: null) {
    @include focus() {
        @include -focus-style($style, $color);
    }
}

// ----------------------------------------------------------------------------
// base
// ----------------------------------------------------------------------------

@function -control-base() {
    @return (
        appearance: none,
        box-sizing: border-box,
        position: relative,
        outline: none,
        border: none,
        white-space: nowrap,
        font-family: get('controls:font-family'),
        font-size: get('controls:font-size'),
        font-weight: get('controls:font-weight')
    );
}

// ----------------------------------------------------------------------------
// button
// ----------------------------------------------------------------------------

@function -button-base-map() {
    @return (
        display: inline-flex,
        align-items: center,
        justify-content: center,
        overflow: hidden,
        text-overflow: ellipsis,
        user-select: none,
        padding: 0 1em,
        border-radius: get('controls:border-radius'),
        min-width: get('controls:min-width'),
        min-height: get('controls:min-height'),
        cursor: pointer,
        disabled: (
            cursor: not-allowed,
        )
    );
}

@function -button-map($accent) {
    @return (
        background: $accent,
        box-shadow: shadow(2, 0.5),
        color: contrast-color($accent),
        hover: (
            background: shade($accent, 1),
            box-shadow: shadow(4, 1),
        ),
        active: (
            background: shade($accent, -2),
            box-shadow: shadow(0),
        ),
        disabled: (
            background: gray(5),
            color: gray(-2),
            box-shadow: none,
        )
    );
}

/// Generates a button style based on the site's button settings. The default button is pretty
/// opinionated. All sizing is in ems (so setting the font size will scale the button). See the
/// source for more details.
///
/// @param {map} $overrides [()] A map containing css key / value pairs. Just about any css is valid (currently transitions can't
/// be override) including supported state specific values: hover, active, disabled. If background
/// or color are set, they will be adapted for other states unless also override for those states
///
/// @example
/// %%include button() => creates a standard, default button
///
/// @example
/// %%include button((font-size: 12px)) => creates a smaller button with a font-size of 12px

@mixin button($overrides: ()) {
    // extract an accent color
    $accent: -get-control-accent($overrides, background, background-color);

    // get basic button css
    $button: -button-map($accent);

    // get the focus css
    $focus: (
        focus: control-focus-style('shadow', rgba($accent, 0.33)),
    );

    // get button defaults if defined
    $config: get('controls:button', null, false);

    // merge all the css
    $css: flat-merge(-control-base(), -button-base-map(), $button, $focus, $config, $overrides);

    // add transitions
    // @todo we need to create a transition function so that this can be included in the css map
    @include transition(background color box-shadow, get('controls:transition', 'fast'));

    // output the css
    @include css-map($css);
}

// ----------------------------------------------------------------------------
// button-outline
// ----------------------------------------------------------------------------

@function -button-outline-map($accent) {
    @return (
        color: $accent,
        border-color: currentColor,
        border-width: 2px,
        border-style: solid,
        hover: (
            color: shade($accent, 2),
            background: rgba(shade($accent, 2), 0.05),
            border-color: shade($accent, 2),
        ),
        active: (
            color: shade($accent, -1),
            background: rgba(shade($accent, -1), 0.1),
            border-color: shade($accent, -1),
        ),
        disabled: (
            background: gray(5),
            color: gray(-2),
            box-shadow: none,
        )
    );
}

/// Generates a (somewhat opinionated) outlined button style based on the site's button settings.
/// Behaves a lot like the `button` mixin so see that for more detail.
///
/// @param {map} $overrides [()] A map containing css key/value pairs. Just about any css is valid
/// (currently transitions can't be overriden) including supported state specific values: hover,
/// active, disabled. The outline color is derived from the border color. The properties
/// border-color and color can be specified as shades (numbers relative to the border-color or
/// primary accent color).
///
///
/// @example
///     @include button-outline(); // => creates a standard outline button
///
/// @todo Robby how do we test the example below? the curly braces throw an error in scratch.
/// @example
///     @include button-outline({border-color: blue}); // => creates a blue outline button

@mixin button-outline($overrides: ()) {
    $accent: -get-control-accent($overrides, color, border-color);

    // button css
    $button: -button-outline-map($accent);

    // config
    $config: get('controls:button', null, false);

    // merge all the css
    $css: flat-merge(-control-base(), -button-base-map(), $button, $config, $overrides);

    // output the css
    @include css-map($css, $map-states: (hover active disabled));

    // add transitions
    @include transition(background color, get('controls:transition', 'fast'));

    // add focus selector
    @include -focus('shadow');
}

/// Generates a simple button with very little styling that can be used to wrap an icon or text but
/// includes basic transitions for hover and active.
///
/// @param {map} $overrides [()]  A map containing css key/value paairs. Just about any css is
/// valid.
///
/// @example
///     @include button-icon() => creates a standard, default button
///
/// @example
///     @include button-icon((font-size: 12px)) => creates a smaller button with a font-size of 12px

@mixin button-icon($overrides: ()) {
    // update accent
    $accent: -get-control-accent($overrides, color, border-color);

    // button css
    $button: -button-outline-map($accent);

    // config
    $config: get('controls:button', null, false);

    // merge all the css
    $css: flat-merge(-control-base(), -button-base-map(), $button, $config, $overrides);

    // output the css
    @include css-map($css, $map-states: (hover active disabled));

    // add transitions
    @include transition(background color, get('controls:transition', 'fast'));

    // add focus selector
    @include -focus('shadow');
}

// ----------------------------------------------------------------------------
// textbox
// ----------------------------------------------------------------------------

@function -textbox-base() {
    @return (
        display: inline-flex,
        border-radius: get('controls:border-radius'),
        min-width: get('controls:min-width'),
        min-height: get('controls:min-height'),
        font-weight: get('controls:font-weight'),
        font-family: get('controls:font-family'),
        border: none,
        background-color: rgba(gray(6), 0.33),
        color: clr('page-fg'),
        padding: 0 0.5em,
        disabled: (
            cursor: not-allowed,
        )
    );
}
///
/// @todo Robby: examples, etc.
@mixin textbox($overrides: ()) {
    // textbox base css
    $textbox: -textbox-base();

    // config
    $config: get('controls:textbox', null, false);

    // merge all the css
    $css: flat-merge(-control-base(), $textbox, $config, $overrides);

    // // add placeholder styles
    // $placeholder: flat-get($css, '-px-placeholder');
    // @if ($placeholder) {
    //     @include placeholder {
    //         color: $placeholder;
    //     }
    // }

    // output the css
    @include css-map($css, $map-states: (hover active disabled));

    // add focus selector
    @include -focus('shadow');
}

// ----------------------------------------------------------------------------
// scrollbar
// ----------------------------------------------------------------------------

/// Customize the appearance of a scrollbar. Good support in modern webkit and chromium based
/// browsers. Has the effect of making scrollbars always visible even if the operating system would
/// normally hide them. There is no way to make the track full transparent. Set $nested to false if
/// apply to all scrollbars (this will remove the parent join).
///
/// @param {*} $size The overall width of the scrollbar
///
/// @param {*} $color The color of the scrollbar thumb (and background is derived from this if not
/// provided)
///
/// @param {*} $radius [0] The border radius of the scrollbar thumb
///
/// @param {*} $background [null] The color of the scrollbar track area (defaults to $color mixed
/// with 50% white if not provided)
///
/// @param {*} $padding [null] Padding around the scrollbar thumb (created artificially with a hack
/// since this isn't supported by the css)
///
/// @param {true} $nested [null] Set to false if this is using outside of a parent selector (to
/// apply to all scrollbars).
///
/// @example @include scrollbar(100%, blue)

@mixin scrollbar($size, $color, $radius: null, $background: null, $padding: null, $nested: true) {
    $background: if-null($background, mix($color, white));

    #{if($nested, unquote('&::'),unquote('::'))}-webkit-scrollbar {
        width: $size;
        height: $size;
    }

    #{if($nested, unquote('&::'),unquote('::'))}-webkit-scrollbar-thumb {
        border-radius: $radius;

        // if $padding is defined, we use a shadow to create the background and
        // a transparent border to create the padding
        @if ($padding) {
            box-shadow: inset 0 0 $size $size $color;
            border: solid $padding transparent;
        } @else {
            background: $color;
        }
    }

    #{if($nested, unquote('&::'),unquote('::'))}-webkit-scrollbar-track {
        background: $background;
    }
}

// ----------------------------------------------------------------------------
// dropdown
// ----------------------------------------------------------------------------

// .dropdown-base {
//     @extend .control-base;
//     cursor: pointer;
//     padding: 0 (2.25 * $control-textbox-padding) 0 $control-textbox-padding;
//     background-repeat: no-repeat;
//     background-position: right $control-textbox-padding top 50%;
//     background-size: $control-select-arrow-width auto;
// }

// .dropdown {
//     @extend .textbox;
//     @extend .dropdown-base;
//     color: $control-select-textbox-fg;
//     background-image: inline-svg(
//         $control-select-arrow-svg,
//         (
//             '#fillcolor': $control-select-textbox-fg,
//         )
//     );
//     &:hover {
//         color: $control-select-textbox-hover-fg;
//         background-image: inline-svg(
//             $control-select-arrow-svg,
//             (
//                 '#fillcolor': $control-select-textbox-hover-fg,
//             )
//         );
//     }
// }

// .dropdown-button {
//     @extend .button;
//     @extend .dropdown-base;
//     color: $control-select-button-fg;
//     line-height: $control-button-height;
//     background-image: inline-svg(
//         $control-select-arrow-svg,
//         (
//             '#fillcolor': $control-select-button-fg,
//         )
//     );
//     &:hover {
//         color: $control-select-button-hover-fg;
//         background-image: inline-svg(
//             $control-select-arrow-svg,
//             (
//                 '#fillcolor': $control-select-button-hover-fg,
//             )
//         );
//     }
//     &:active {
//         color: $control-select-button-active-fg;
//         background-image: inline-svg(
//             $control-select-arrow-svg,
//             (
//                 '#fillcolor': $control-select-button-active-fg,
//             )
//         );
//     }
// }
